(function(){
function m() {
  return function() {
  }
}
window.JSON && window.JSON.stringify || function() {
  function a(a) {
    d.lastIndex = 0;
    return d.test(a) ? '"' + a.replace(d, function(a) {
      var b = f[a];
      return"string" === typeof b ? b : "\\u" + ("0000" + a.charCodeAt(0).toString(16)).slice(-4)
    }) + '"' : '"' + a + '"'
  }
  function c(d, q) {
    var g, j, n, f, u = b, h, e = q[d];
    e && ("object" === typeof e && "function" === typeof e.toJSON) && (e = e.toJSON(d));
    "function" === typeof k && (e = k.call(q, d, e));
    switch(typeof e) {
      case "string":
        return a(e);
      case "number":
        return isFinite(e) ? String(e) : "null";
      case "boolean":
      ;
      case "null":
        return String(e);
      case "object":
        if(!e) {
          return"null"
        }
        b += i;
        h = [];
        if("[object Array]" === Object.prototype.toString.apply(e)) {
          f = e.length;
          for(g = 0;g < f;g += 1) {
            h[g] = c(g, e) || "null"
          }
          n = 0 === h.length ? "[]" : b ? "[\n" + b + h.join(",\n" + b) + "\n" + u + "]" : "[" + h.join(",") + "]";
          b = u;
          return n
        }
        if(k && "object" === typeof k) {
          f = k.length;
          for(g = 0;g < f;g += 1) {
            j = k[g], "string" === typeof j && (n = c(j, e)) && h.push(a(j) + (b ? ": " : ":") + n)
          }
        }else {
          for(j in e) {
            Object.hasOwnProperty.call(e, j) && (n = c(j, e)) && h.push(a(j) + (b ? ": " : ":") + n)
          }
        }
        n = 0 === h.length ? "{}" : b ? "{\n" + b + h.join(",\n" + b) + "\n" + u + "}" : "{" + h.join(",") + "}";
        b = u;
        return n
    }
  }
  window.JSON || (window.JSON = {});
  "function" !== typeof String.prototype.toJSON && (String.prototype.toJSON = Number.prototype.toJSON = Boolean.prototype.toJSON = function() {
    return this.valueOf()
  });
  var d = /[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, b, i, f = {"\b":"\\b", "\t":"\\t", "\n":"\\n", "\f":"\\f", "\r":"\\r", '"':'\\"', "\\":"\\\\"}, k;
  "function" !== typeof JSON.stringify && (JSON.stringify = function(a, d, g) {
    var f;
    i = b = "";
    if("number" === typeof g) {
      for(f = 0;f < g;f += 1) {
        i += " "
      }
    }else {
      "string" === typeof g && (i = g)
    }
    if((k = d) && "function" !== typeof d && ("object" !== typeof d || "number" !== typeof d.length)) {
      throw Error("JSON.stringify");
    }
    return c("", {"":a})
  });
  "function" !== typeof JSON.parse && (JSON.parse = function(a) {
    return eval("(" + a + ")")
  })
}();
function p() {
  return+new Date
}
var y, z = Math.floor(20 * Math.random());
y = function(a) {
  return 0 < a.indexOf("pubsub") && a.replace("pubsub", "ps" + (20 > ++z ? z : z = 1)) || a
};
function B(a, c) {
  if(a && c) {
    if("undefined" != typeof a[0]) {
      for(var d = 0, b = a.length;d < b;) {
        c.call(a[d], a[d], d++)
      }
    }else {
      for(d in a) {
        a.hasOwnProperty && a.hasOwnProperty(d) && c.call(a[d], d, a[d])
      }
    }
  }
}
function C(a, c) {
  var d = [];
  B(a || [], function(a, i) {
    d.push(c(a, i))
  });
  return d
}
var G = Math.floor(20 * Math.random());
y = function(a) {
  return 0 < a.indexOf("pubsub") && a.replace("pubsub", "ps" + (20 > ++G ? G : G = 1)) || a
};
function H(a) {
  return C(encodeURIComponent(a).split(""), function(a) {
    return 0 > "-_.!~*'()".indexOf(a) ? a : "%" + a.charCodeAt(0).toString(16).toUpperCase()
  }).join("")
}
function I(a) {
  var c = [];
  B(a, function(a, b) {
    b.f && c.push(a)
  });
  return c.sort()
}
SECOND = 1E3;
function J(a) {
  function c(a) {
    i || (i = 1, clearTimeout(k), b && (b.onerror = b.onload = null, b.abort && b.abort(), b = null), a && t())
  }
  function d() {
    if(!f) {
      f = 1;
      clearTimeout(k);
      try {
        response = JSON.parse(b.responseText)
      }catch(a) {
        return c(1)
      }
      q(response)
    }
  }
  var b, i = 0, f = 0, k;
  k = setTimeout(function() {
    c(1)
  }, K);
  var t = a.b || m(), q = a.c || m();
  try {
    b = "undefined" !== typeof XDomainRequest && new XDomainRequest || new XMLHttpRequest;
    b.onerror = b.onabort = function() {
      c(1)
    };
    b.onload = b.onloadend = d;
    b.timeout = K;
    url = a.url.join(N);
    if(a.data) {
      var g = [];
      url += "?";
      for(key in a.data) {
        g.push(key + "=" + a.data[key])
      }
      url += g.join(O)
    }
    b.open("GET", url, !0);
    b.send()
  }catch(j) {
    return c(0), J(a)
  }
  return c
}
var N = "/", O = "&", K = 31E4, P, Q = "undefined" != typeof localStorage && localStorage;
P = {get:function(a) {
  try {
    return Q ? Q.getItem(a) : -1 == document.cookie.indexOf(a) ? null : ((document.cookie || "").match(RegExp(a + "=([^;]+)")) || [])[1] || null
  }catch(c) {
  }
}, set:function(a, c) {
  try {
    if(Q) {
      return Q.setItem(a, c) && 0
    }
    document.cookie = a + "=" + c + "; expires=Thu, 1 Aug 2030 20:00:00 UTC; path=/"
  }catch(d) {
  }
}};
var S = {list:{}, unbind:function(a) {
  S.list[a] = []
}, bind:function(a, c) {
  (S.list[a] = S.list[a] || []).push(c)
}, fire:function(a, c) {
  B(S.list[a] || [], function(a) {
    a(c)
  })
}};
function T(a) {
  function c() {
  }
  function d() {
  }
  function b(a) {
    B(I(f), function(r) {
      (r = f[r]) && a(r)
    })
  }
  var i = {xdr:J, db:P, each:B, map:C, events:S, init:T};
  a.db = P;
  a.xdr = J;
  var f = {}, k = [], t = 0, q = "-pnpres", g = 0, j = 0, n = 0, F = 0, u = 0, h = 0, e = a.publish_key || "", l = a.subscribe_key || "", D = a.ssl ? "s" : "", E = a.db || {set:m(), get:m()}, v = a.jsonp_cb || function() {
    return 0
  }, L = a.bind_leave || m(), w = a.xdr, A = a.uuid || E.get(l + "uuid") || "", s = "http" + D + "://" + (a.origin || "pubsub.pubnub.com"), x = {history:function(a, r) {
    var r = a.callback || r, b = a.count || a.limit || 100, c = a.reverse || "false", d = a.error || m(), e = a.channel, f = a.start, g = a.end, h = {}, k = v();
    if(!e) {
      return error("Missing Channel")
    }
    if(!r) {
      return error("Missing Callback")
    }
    if(!l) {
      return error("Missing Subscribe Key")
    }
    h.count = b;
    h.reverse = c;
    f && (h.start = f);
    g && (h.end = g);
    w({a:k, data:h, c:function(a) {
      r(a)
    }, b:d, url:[s, "v2", "history", "sub-key", l, "channel", H(e)]})
  }, replay:function(a) {
    var b = b || a.callback || m(), c = a.source, d = a.destination, f = a.stop, g = a.start, h = a.end, k = a.reverse, a = a.limit, i = v(), j = {};
    if(!c) {
      return error("Missing Source Channel")
    }
    if(!d) {
      return error("Missing Destination Channel")
    }
    if(!e) {
      return error("Missing Publish Key")
    }
    if(!l) {
      return error("Missing Subscribe Key")
    }
    "0" != i && (j.callback = i);
    f && (j.stop = "all");
    k && (j.reverse = "true");
    g && (j.start = g);
    h && (j.end = h);
    a && (j.count = a);
    w({a:i, c:function(a) {
      b(a)
    }, b:function() {
      b([0, "Disconnected"])
    }, url:[s, "v1", "replay", e, l, c, d], data:j})
  }, time:function(a) {
    var b = v(), c = y(s);
    w({a:b, url:[c, "time", b], c:function(b) {
      a(b[0])
    }, b:function() {
      a(0)
    }})
  }, uuid:function(a) {
    var b = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(a) {
      var b = 16 * Math.random() | 0;
      return("x" == a ? b : b & 3 | 8).toString(16)
    });
    a && a(b);
    return b
  }, publish:function(a, b) {
    var b = b || a.callback || m(), c = a.message, d = a.channel, f = v();
    if(!c) {
      return error("Missing Message")
    }
    if(!d) {
      return error("Missing Channel")
    }
    if(!e) {
      return error("Missing Publish Key")
    }
    if(!l) {
      return error("Missing Subscribe Key")
    }
    c = JSON.stringify(c);
    c = [s, "publish", e, l, 0, H(d), f, H(c)];
    w({a:f, c:function(a) {
      b(a)
    }, b:function() {
      b([0, "Disconnected"])
    }, url:c, data:{uuid:A}})
  }, unsubscribe:function(a) {
    a = a.channel;
    h = 0;
    F = 1;
    a = C((a.join ? a.join(",") : "" + a).split(","), function(a) {
      return a + "," + a + q
    }).join(",");
    B(a.split(","), function(a) {
      t && d(a, 0);
      f[a] = 0
    });
    t && c()
  }, subscribe:function(a, d) {
    function e() {
      var a = v(), c = I(f).join(",");
      c && (n = w({timeout:X, a:a, data:{uuid:A}, url:[R, "subscribe", l, H(c), a, h], b:function() {
        b(function(a) {
          a.d || (a.d = 1, a.h(a.name))
        });
        R = y(s);
        setTimeout(e, SECOND);
        x.time(function(a) {
          b(function(b) {
            a && b.d ? (b.d = 0, b.i(b.name)) : b.error()
          })
        })
      }, c:function(a) {
        if(!a) {
          return setTimeout(e, 10)
        }
        b(function(a) {
          a.e || (a.e = 1, a.g(a.name))
        });
        h = !h && F && E.get(l) || a[1];
        E.set(l, a[1]);
        var c, d = (2 < a.length ? a[2] : "").split(",");
        c = function() {
          var a = d.shift() || "";
          return[(f[a] || {}).a || g, (a || j).split(q)[0]]
        };
        B(a[0], function(b) {
          var d = c();
          if(f[d[1]].f) {
            d[0](b, a, d[1])
          }
        });
        setTimeout(e, 10)
      }}))
    }
    var i = a.channel, d = (d = d || a.callback) || a.message, U = a.error || m(), V = a.connect || m(), W = a.reconnect || m(), D = a.disconnect || m(), M = a.presence || 0, L = a.noheresync || 0, X = a.timeout || 31E4, Y = a.restore, R = y(s);
    Y && (F = 1);
    if(!i) {
      return error("Missing Channel")
    }
    if(!d) {
      return error("Missing Callback")
    }
    if(!l) {
      return error("Missing Subscribe Key")
    }
    B((i.join ? i.join(",") : "" + i).split(","), function(a) {
      var b = f[a] || {};
      f[j = a] = {name:a, e:b.e, d:b.d, f:1, a:g = d, g:V, error:U, h:D, i:W};
      M && (x.subscribe({channel:a + q, callback:M}), !b.f && !L && x.here_now({channel:a, callback:function(b) {
        B("uuids" in b ? b.uuids : [], function(c) {
          M({action:"join", uuid:c, timestamp:p(), occupancy:b.occupancy || 1}, b, a)
        })
      }}))
    });
    c = function() {
      n && n();
      clearTimeout(u);
      u = setTimeout(e, 100)
    };
    if(!t) {
      return k.push(c)
    }
    c()
  }, here_now:function(a, b) {
    var b = a.callback || b, c = a.error || m(), d = a.channel, e = v(), f = {};
    if(!d) {
      return error("Missing Channel")
    }
    if(!b) {
      return error("Missing Callback")
    }
    if(!l) {
      return error("Missing Subscribe Key")
    }
    "0" != e && (f.callback = e);
    w({a:e, data:f, c:function(a) {
      b(a)
    }, b:c, url:[s, "v2", "presence", "sub_key", l, "channel", H(d)]})
  }, ready:function() {
    x.time(p);
    x.time(function() {
      setTimeout(function() {
        t || (t = 1, B(k, function(a) {
          a()
        }))
      }, SECOND)
    })
  }}, d = function(a, b) {
    var c = {uuid:A}, d = y(s), e = v();
    0 < a.indexOf(q) || ("0" != e && (c.callback = e), w({k:b || D, timeout:2E3, a:e, data:c, url:[d, "v2", "presence", "sub_key", l, "channel", H(a), "leave"]}))
  };
  A || (A = x.uuid());
  E.set(l + "uuid", A);
  L();
  i.__proto__ = x;
  i.ready();
  return i
}
"undefined" !== typeof module && (module.l = PN) || "undefined" !== typeof exports && (exports.j = PN) || (PUBNUB = T({}));

})();
